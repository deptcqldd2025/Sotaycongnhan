<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVN E-Signer v2.0 - B·∫£o M·∫≠t & X√°c Th·ª±c</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@2.6.347/build/pdf.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@2.6.347/build/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .header-app { background: linear-gradient(135deg, #b71c1c 0%, #880e4f 100%); color: white; padding: 15px 0; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .card-custom { border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: none; overflow: hidden; }
        .nav-tabs .nav-link { color: #555; font-weight: 600; border: none; border-bottom: 3px solid transparent; }
        .nav-tabs .nav-link.active { color: #b71c1c; border-bottom: 3px solid #b71c1c; background: none; }
        .btn-sign { background-color: #b71c1c; color: white; font-weight: bold; border: none; }
        .btn-sign:hover { background-color: #880e4f; color: white; }
        .btn-verify { background-color: #2e7d32; color: white; font-weight: bold; border: none; }
        .btn-verify:hover { background-color: #1b5e20; color: white; }
        .log-box { background: #1e1e1e; color: #00ff00; font-family: 'Consolas', monospace; padding: 15px; border-radius: 8px; height: 150px; overflow-y: auto; font-size: 13px; display: none; margin-top: 15px;}
        .result-box { padding: 20px; border-radius: 8px; margin-top: 20px; text-align: center; display: none; }
        .valid { background-color: #e8f5e9; border: 2px solid #2e7d32; color: #1b5e20; }
        .invalid { background-color: #ffebee; border: 2px solid #c62828; color: #c62828; }
    </style>
</head>
<body>

<div class="header-app">
    <div class="container d-flex justify-content-between align-items-center">
        <h4 class="m-0">üõ°Ô∏è EVN SECURE SIGNER</h4>
        <span class="badge bg-light text-danger">Ver 2.0 (Security)</span>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card card-custom p-4">
                
                <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="sign-tab" data-bs-toggle="tab" data-bs-target="#sign-panel" type="button">üñäÔ∏è K√ù VƒÇN B·∫¢N</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="verify-tab" data-bs-toggle="tab" data-bs-target="#verify-panel" type="button">üîç KI·ªÇM TRA TH·∫¨T/GI·∫¢</button>
                    </li>
                </ul>

                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="sign-panel">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="fw-bold">T√™n ng∆∞·ªùi k√Ω:</label>
                                <input type="text" id="nameToFind" class="form-control" value="Tr·∫ßn C√¥ng ƒê·∫πp">
                            </div>
                            <div class="col-md-6">
                                <label class="fw-bold">V·ªã tr√≠ (Offset Y):</label>
                                <input type="number" id="offsetY" class="form-control" value="0">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="fw-bold">R·ªông:</label>
                                <input type="number" id="sigWidth" class="form-control" value="140">
                            </div>
                            <div class="col-6">
                                <label class="fw-bold">Cao:</label>
                                <input type="number" id="sigHeight" class="form-control" value="70">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="fw-bold">1. File PDF:</label>
                            <input type="file" id="pdfFile" class="form-control" accept=".pdf">
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">2. ·∫¢nh ch·ªØ k√Ω:</label>
                            <input type="file" id="imgFile" class="form-control" accept=".png,.jpg">
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="removeBg" checked>
                            <label class="form-check-label" for="removeBg">T·ª± ƒë·ªông x√≥a n·ªÅn tr·∫Øng</label>
                        </div>
                        <div class="form-check form-switch mb-4">
                            <input class="form-check-input" type="checkbox" id="onlyLastPage">
                            <label class="form-check-label text-danger" for="onlyLastPage">Ch·ªâ k√Ω trang cu·ªëi</label>
                        </div>

                        <button class="btn btn-sign w-100 py-2" onclick="startSigning()">
                            üîí K√ù & ƒê√ìNG D·∫§U B·∫¢O M·∫¨T
                        </button>
                        <div id="signLog" class="log-box"></div>
                    </div>

                    <div class="tab-pane fade" id="verify-panel">
                        <div class="text-center mb-4">
                            <p class="text-muted">T·∫£i file PDF l√™n ƒë·ªÉ ki·ªÉm tra xem n√≥ c√≥ ƒë∆∞·ª£c k√Ω b·ªüi App n√†y kh√¥ng.</p>
                            <input type="file" id="verifyFile" class="form-control mb-3" accept=".pdf">
                            <button class="btn btn-verify w-100 py-2" onclick="verifyDocument()">
                                üïµÔ∏è QU√âT KI·ªÇM TRA
                            </button>
                        </div>
                        <div id="verifyResult" class="result-box"></div>
                    </div>

                </div>
            </div>
            <div class="text-center mt-3 text-muted small">
                B·∫£o m·∫≠t b·ªüi thu·∫≠t to√°n Hash SHA-256 & PDF Metadata
            </div>
        </div>
    </div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@2.6.347/build/pdf.worker.min.js';

    // === C·∫§U H√åNH M√É B√ç M·∫¨T ===
    const APP_SECRET_KEY = "EVN_SECURE_APP_V2_BY_TRANCONGDEP"; // M√£ n√†y d√πng ƒë·ªÉ nh·∫≠n di·ªán

    function log(msg) {
        const d = document.getElementById('signLog');
        d.style.display = 'block';
        d.innerHTML += `> ${msg}<br>`;
        d.scrollTop = d.scrollHeight;
    }

    // --- H√ÄM 1: X√ìA N·ªÄN ---
    function removeWhiteBackground(imageBytes) {
        return new Promise((resolve) => {
            const blob = new Blob([imageBytes]);
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    if (data[i] > 200 && data[i + 1] > 200 && data[i + 2] > 200) data[i + 3] = 0;
                }
                ctx.putImageData(imageData, 0, 0);
                canvas.toBlob((blob) => { blob.arrayBuffer().then(resolve); }, 'image/png');
            };
            img.src = URL.createObjectURL(blob);
        });
    }

    // --- H√ÄM 2: K√ù S·ªê & ƒê√ìNG D·∫§U B·∫¢O M·∫¨T ---
    async function startSigning() {
        const pdfInput = document.getElementById('pdfFile').files[0];
        const imgInput = document.getElementById('imgFile').files[0];
        const nameToFind = document.getElementById('nameToFind').value;
        const width = parseInt(document.getElementById('sigWidth').value);
        const height = parseInt(document.getElementById('sigHeight').value);
        const offset = parseInt(document.getElementById('offsetY').value);
        const isRemoveBg = document.getElementById('removeBg').checked;
        const isOnlyLastPage = document.getElementById('onlyLastPage').checked;

        if (!pdfInput || !imgInput) return alert("Thi·∫øu file!");

        document.getElementById('signLog').innerHTML = "";
        log("ƒêang kh·ªüi t·∫°o quy tr√¨nh b·∫£o m·∫≠t...");

        try {
            const pdfBytes = await pdfInput.arrayBuffer();
            let imgBytes = await imgInput.arrayBuffer();

            if (isRemoveBg) imgBytes = await removeWhiteBackground(imgBytes);

            const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
            const sigImg = await pdfDoc.embedPng(imgBytes);

            // --- T·∫†O M√É B·∫¢O M·∫¨T ---
            const timestamp = new Date().toISOString();
            const uniqueID = Math.random().toString(36).substring(2, 10).toUpperCase();
            // T·∫°o chu·ªói m√£ h√≥a ƒë·ªÉ nh√∫ng v√†o file
            const securityString = `${APP_SECRET_KEY}|${uniqueID}|${timestamp}`;
            
            // Nh√∫ng Metadata (Ng∆∞·ªùi th∆∞·ªùng kh√¥ng th·∫•y)
            pdfDoc.setKeywords([securityString]); 
            pdfDoc.setProducer('EVN Secure Signer App v2.0');
            pdfDoc.setSubject(`Digitally Signed by ${nameToFind}`);

            // T√¨m v·ªã tr√≠ k√Ω
            const loadingTask = pdfjsLib.getDocument({data: pdfBytes});
            const pdfScanner = await loadingTask.promise;
            let count = 0;
            const totalPages = pdfScanner.numPages;
            let startPage = isOnlyLastPage ? totalPages : 1;
            let endPage = totalPages;

            for (let i = startPage; i <= endPage; i++) {
                const page = await pdfScanner.getPage(i);
                const textContent = await page.getTextContent();
                let matches = [];
                for (let item of textContent.items) {
                    if (item.str.includes(nameToFind)) matches.push(item);
                }

                if (matches.length > 0) {
                    matches.sort((a, b) => a.transform[5] - b.transform[5]);
                    const bestMatch = matches[0];
                    
                    const x = bestMatch.transform[4] + (bestMatch.width - width) / 2;
                    const y = bestMatch.transform[5] + offset;
                    
                    const pdfPage = pdfDoc.getPages()[i - 1];
                    pdfPage.drawImage(sigImg, { x: x, y: y + 5, width: width, height: height });
                    
                    // --- IN M√É S·ªê NH·ªé V√ÄO CH√ÇN TRANG ƒê·ªÇ D·ªÑ ƒê·ªêI CHI·∫æU ---
                    const { width: pageWidth } = pdfPage.getSize();
                    pdfPage.drawText(`Digital ID: ${uniqueID} | Signed via EVN App`, {
                        x: 20,
                        y: 10,
                        size: 8,
                        color: PDFLib.rgb(0.5, 0.5, 0.5),
                    });

                    count++;
                }
            }

            if (count > 0) {
                const pdfBytesSaved = await pdfDoc.save();
                const blob = new Blob([pdfBytesSaved], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = pdfInput.name.replace(".pdf", "_secured.pdf");
                link.click();
                log(`‚úÖ ƒê√£ k√Ω b·∫£o m·∫≠t th√†nh c√¥ng! ID: ${uniqueID}`);
            } else {
                alert("Kh√¥ng t√¨m th·∫•y t√™n.");
            }
        } catch (e) {
            console.error(e);
            alert("L·ªói: " + e.message);
        }
    }

    // --- H√ÄM 3: KI·ªÇM TRA VƒÇN B·∫¢N (QUAN TR·ªåNG) ---
    async function verifyDocument() {
        const fileInput = document.getElementById('verifyFile').files[0];
        const resBox = document.getElementById('verifyResult');
        
        if (!fileInput) return alert("Vui l√≤ng ch·ªçn file c·∫ßn ki·ªÉm tra!");

        resBox.style.display = 'block';
        resBox.innerHTML = "‚è≥ ƒêang qu√©t metadata...";
        resBox.className = "result-box";

        try {
            const arrayBuffer = await fileInput.arrayBuffer();
            const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
            
            // ƒê·ªçc th√¥ng tin ·∫©n (Keywords)
            const keywords = pdfDoc.getKeywords();
            
            // Logic ki·ªÉm tra: Ph·∫£i ch·ª©a m√£ b√≠ m·∫≠t APP_SECRET_KEY
            if (keywords && keywords.includes(APP_SECRET_KEY)) {
                // T√°ch th√¥ng tin
                const parts = keywords.split('|');
                const id = parts[1] || 'Unknown';
                const time = parts[2] || 'Unknown';

                resBox.innerHTML = `
                    <h3 class="mb-2">‚úÖ VƒÇN B·∫¢N H·ª¢P L·ªÜ</h3>
                    <p>File n√†y ƒë∆∞·ª£c k√Ω b·ªüi h·ªá th·ªëng <strong>EVN Secure App</strong>.</p>
                    <hr>
                    <div class="text-start d-inline-block">
                        <p><strong>M√£ giao d·ªãch (ID):</strong> ${id}</p>
                        <p><strong>Th·ªùi gian k√Ω:</strong> ${time}</p>
                        <p><strong>Ng∆∞·ªùi t·∫°o:</strong> ${pdfDoc.getProducer() || 'N/A'}</p>
                    </div>
                `;
                resBox.className = "result-box valid";
            } else {
                resBox.innerHTML = `
                    <h3 class="mb-2">‚ùå C·∫¢NH B√ÅO: KH√îNG H·ª¢P L·ªÜ</h3>
                    <p>File n√†y <strong>KH√îNG</strong> t√¨m th·∫•y ch·ªØ k√Ω s·ªë c·ªßa App n√†y.</p>
                    <p class="small">C√≥ th·ªÉ file ƒë√£ b·ªã gh√©p b√™n ngo√†i ho·∫∑c ch·ªânh s·ª≠a l·∫°i.</p>
                `;
                resBox.className = "result-box invalid";
            }

        } catch (e) {
            resBox.innerHTML = "‚ùå L·ªói: Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file PDF.";
            resBox.className = "result-box invalid";
        }
    }
</script>

</body>
</html>

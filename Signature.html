<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVN E-Signer - K√Ω S·ªë Th√¥ng Minh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@2.6.347/build/pdf.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@2.6.347/build/pdf.worker.min.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .header-app { background: #0056b3; color: white; padding: 15px 0; margin-bottom: 20px; }
        .card-custom { border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: none; }
        .btn-primary { background-color: #0056b3; border: none; padding: 10px 20px; }
        .log-box { background: #1e1e1e; color: #00ff00; font-family: monospace; padding: 15px; border-radius: 5px; height: 200px; overflow-y: auto; font-size: 13px; margin-top: 15px; display: none; }
    </style>
</head>
<body>

<div class="header-app">
    <div class="container">
        <h4 class="m-0">‚úçÔ∏è H·ªÜ TH·ªêNG K√ù S·ªê (CH·ªà K√ù CU·ªêI TRANG)</h4>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card card-custom p-4">
                <div class="alert alert-info">
                    <strong>C·∫≠p nh·∫≠t m·ªõi:</strong> H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông b·ªè qua t√™n ·ªü ph·∫ßn ƒë·∫ßu trang/gi·ªØa trang v√† <b>ch·ªâ k√Ω v√†o v·ªã tr√≠ th·∫•p nh·∫•t (cu·ªëi trang)</b>.
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="fw-bold">T√™n ng∆∞·ªùi k√Ω:</label>
                        <input type="text" id="nameToFind" class="form-control" value="Tr·∫ßn C√¥ng ƒê·∫πp">
                    </div>
                    <div class="col-md-6">
                        <label class="fw-bold">V·ªã tr√≠ (Offset Y):</label>
                        <input type="number" id="offsetY" class="form-control" value="0" placeholder="S·ªë √¢m ƒë·ªÉ ƒë√® l√™n t√™n">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="fw-bold">K√≠ch th∆∞·ªõc R·ªông:</label>
                        <input type="number" id="sigWidth" class="form-control" value="140">
                    </div>
                    <div class="col-md-6">
                        <label class="fw-bold">K√≠ch th∆∞·ªõc Cao:</label>
                        <input type="number" id="sigHeight" class="form-control" value="70">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="fw-bold">1. File PDF:</label>
                    <input type="file" id="pdfFile" class="form-control" accept=".pdf">
                </div>

                <div class="mb-4">
                    <label class="fw-bold">2. ·∫¢nh ch·ªØ k√Ω (PNG):</label>
                    <input type="file" id="imgFile" class="form-control" accept=".png,.jpg">
                </div>
                
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="onlyLastPage">
                    <label class="form-check-label text-danger fw-bold" for="onlyLastPage">Ch·ªâ k√Ω duy nh·∫•t trang cu·ªëi c√πng c·ªßa file (D√πng cho t·ªù tr√¨nh)</label>
                </div>

                <button class="btn btn-primary w-100 fw-bold" onclick="startSigning()">üöÄ K√ù T√äN & T·∫¢I V·ªÄ</button>

                <div id="statusLog" class="log-box"></div>
            </div>
        </div>
    </div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@2.6.347/build/pdf.worker.min.js';

    function log(msg) {
        const d = document.getElementById('statusLog');
        d.style.display = 'block';
        d.innerHTML += `> ${msg}<br>`;
        d.scrollTop = d.scrollHeight;
    }

    async function startSigning() {
        const pdfInput = document.getElementById('pdfFile').files[0];
        const imgInput = document.getElementById('imgFile').files[0];
        const nameToFind = document.getElementById('nameToFind').value;
        const width = parseInt(document.getElementById('sigWidth').value);
        const height = parseInt(document.getElementById('sigHeight').value);
        const offset = parseInt(document.getElementById('offsetY').value);
        const onlyLastPage = document.getElementById('onlyLastPage').checked;

        if (!pdfInput || !imgInput) return alert("Thi·∫øu file!");

        document.getElementById('statusLog').innerHTML = "";
        log("ƒêang x·ª≠ l√Ω...");

        try {
            const pdfBytes = await pdfInput.arrayBuffer();
            const imgBytes = await imgInput.arrayBuffer();

            const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
            
            // Nh√∫ng ·∫£nh
            let sigImg;
            if (imgInput.name.toLowerCase().endsWith('.png')) sigImg = await pdfDoc.embedPng(imgBytes);
            else sigImg = await pdfDoc.embedJpg(imgBytes);

            const loadingTask = pdfjsLib.getDocument({data: pdfBytes});
            const pdfScanner = await loadingTask.promise;
            
            let count = 0;
            const totalPages = pdfScanner.numPages;

            // X√°c ƒë·ªãnh trang c·∫ßn qu√©t (N·∫øu t√≠ch ch·ªçn 'Ch·ªâ trang cu·ªëi' th√¨ ch·ªâ qu√©t trang cu·ªëi)
            let startPage = 1; 
            let endPage = totalPages;
            
            if (onlyLastPage) {
                startPage = totalPages;
                log("‚ö†Ô∏è Ch·∫ø ƒë·ªô: Ch·ªâ k√Ω trang cu·ªëi c√πng c·ªßa file.");
            } else {
                log("‚ÑπÔ∏è Ch·∫ø ƒë·ªô: K√Ω v√†o v·ªã tr√≠ th·∫•p nh·∫•t c·ªßa m·ªói trang.");
            }

            for (let i = startPage; i <= endPage; i++) {
                const page = await pdfScanner.getPage(i);
                const textContent = await page.getTextContent();
                
                // M·∫£ng ch·ª©a c√°c v·ªã tr√≠ t√¨m th·∫•y t√™n trong trang n√†y
                let matchesOnPage = [];

                for (let item of textContent.items) {
                    if (item.str.includes(nameToFind)) {
                        matchesOnPage.push(item);
                    }
                }

                // N·∫æU T√åM TH·∫§Y T√äN TRONG TRANG
                if (matchesOnPage.length > 0) {
                    // S·∫Øp x·∫øp theo v·ªã tr√≠ Y (t·ª´ th·∫•p ƒë·∫øn cao)
                    // Trong PDF, to·∫° ƒë·ªô (0,0) l√† g√≥c d∆∞·ªõi c√πng b√™n tr√°i.
                    // Nghƒ©a l√† Y c√†ng nh·ªè th√¨ c√†ng n·∫±m g·∫ßn ƒë√°y trang.
                    
                    matchesOnPage.sort((a, b) => a.transform[5] - b.transform[5]);

                    // L·∫•y ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n (c√≥ Y nh·ªè nh·∫•t -> n·∫±m d∆∞·ªõi c√πng nh·∫•t)
                    const bestMatch = matchesOnPage[0]; 

                    log(`--> Trang ${i}: T√¨m th·∫•y ${matchesOnPage.length} v·ªã tr√≠. Ch·ªçn v·ªã tr√≠ th·∫•p nh·∫•t (Y=${Math.round(bestMatch.transform[5])}).`);
                    
                    const x_text = bestMatch.transform[4];
                    const y_text = bestMatch.transform[5];
                    const textWidth = bestMatch.width;
                    
                    const x_img = x_text + (textWidth - width) / 2;
                    const y_img = y_text + offset;
                    
                    const pdfPage = pdfDoc.getPages()[i - 1];
                    
                    pdfPage.drawImage(sigImg, {
                        x: x_img,
                        y: y_img + 5, // ƒêi·ªÅu ch·ªânh nh·∫π l√™n tr√™n d√≤ng k·∫ª
                        width: width,
                        height: height,
                    });
                    count++;
                }
            }

            if (count > 0) {
                const pdfBytesSaved = await pdfDoc.save();
                const blob = new Blob([pdfBytesSaved], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = pdfInput.name.replace(".pdf", "_signed.pdf");
                link.click();
                log(`‚úÖ XONG! ƒê√£ k√Ω ${count} ch·ªó.`);
            } else {
                log("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y t√™n ƒë·ªÉ k√Ω.");
                alert("Kh√¥ng t√¨m th·∫•y t√™n trong ph·∫°m vi ƒë√£ ch·ªçn.");
            }

        } catch (e) {
            console.error(e);
            log("‚ùå L·ªói: " + e.message);
        }
    }
</script>

</body>
</html>

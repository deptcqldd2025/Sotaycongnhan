<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVN E-Signer - K√Ω S·ªë T·ª± ƒê·ªông</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@2.6.347/build/pdf.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@2.6.347/build/pdf.worker.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .header-evn {
            background: linear-gradient(90deg, #0056b3 0%, #004494 100%);
            color: white; padding: 15px 0; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-custom { border: none; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .btn-evn { background-color: #0056b3; color: white; font-weight: 600; padding: 12px 30px; }
        .btn-evn:hover { background-color: #003d82; color: white; }
        .status-log { background: #000; color: #0f0; font-family: monospace; padding: 10px; border-radius: 5px; height: 150px; overflow-y: auto; font-size: 12px; display: none; }
    </style>
</head>
<body>

<div class="header-evn">
    <div class="container d-flex justify-content-between align-items-center">
        <h4 class="m-0">‚úçÔ∏è H·ªÜ TH·ªêNG K√ù S·ªê T·ª∞ ƒê·ªòNG</h4>
        <span class="badge bg-light text-primary">Web Version</span>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card card-custom p-4">
                <h5 class="mb-4 text-primary fw-bold border-bottom pb-2">Thi·∫øt l·∫≠p th√¥ng s·ªë</h5>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">T√™n c·∫ßn t√¨m:</label>
                        <input type="text" id="nameToFind" class="form-control" value="Tr·∫ßn C√¥ng ƒê·∫πp">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Kho·∫£ng c√°ch (Offset Y):</label>
                        <input type="number" id="offsetY" class="form-control" value="0" placeholder="S·ªë √¢m ƒë·ªÉ ƒë√® l√™n t√™n">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Chi·ªÅu r·ªông ch·ªØ k√Ω:</label>
                        <input type="number" id="sigWidth" class="form-control" value="140">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Chi·ªÅu cao ch·ªØ k√Ω:</label>
                        <input type="number" id="sigHeight" class="form-control" value="70">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">1. Ch·ªçn file PDF:</label>
                    <input type="file" id="pdfFile" class="form-control" accept=".pdf">
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">2. Ch·ªçn ·∫£nh ch·ªØ k√Ω (PNG/JPG):</label>
                    <input type="file" id="imgFile" class="form-control" accept=".png,.jpg,.jpeg">
                </div>

                <div class="text-center">
                    <button class="btn btn-evn w-100 shadow" onclick="startSigning()">
                        üöÄ B·∫ÆT ƒê·∫¶U K√ù & T·∫¢I V·ªÄ
                    </button>
                </div>

                <div id="statusLog" class="status-log mt-3"></div>
            </div>
            <div class="text-center mt-3 text-muted small">
                ·ª®ng d·ª•ng ch·∫°y ho√†n to√†n tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n. File kh√¥ng ƒë∆∞·ª£c g·ª≠i ƒëi ƒë√¢u c·∫£ (B·∫£o m·∫≠t 100%).
            </div>
        </div>
    </div>
</div>

<script>
    // --- C·∫§U H√åNH PDF.JS ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@2.6.347/build/pdf.worker.min.js';

    function log(msg) {
        const logDiv = document.getElementById('statusLog');
        logDiv.style.display = 'block';
        logDiv.innerHTML += `> ${msg}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function startSigning() {
        const pdfInput = document.getElementById('pdfFile').files[0];
        const imgInput = document.getElementById('imgFile').files[0];
        const nameToFind = document.getElementById('nameToFind').value;
        const width = parseInt(document.getElementById('sigWidth').value);
        const height = parseInt(document.getElementById('sigHeight').value);
        const offset = parseInt(document.getElementById('offsetY').value);

        if (!pdfInput || !imgInput) {
            alert("Vui l√≤ng ch·ªçn ƒë·ªß File PDF v√† ·∫¢nh ch·ªØ k√Ω!");
            return;
        }

        document.getElementById('statusLog').innerHTML = "";
        log("ƒêang ƒë·ªçc file...");

        try {
            // 1. ƒê·ªçc file
            const pdfBytes = await pdfInput.arrayBuffer();
            const imgBytes = await imgInput.arrayBuffer();

            // 2. Kh·ªüi t·∫°o th∆∞ vi·ªán PDF-LIB ƒë·ªÉ ch·ªânh s·ª≠a
            const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
            
            // Nh√∫ng ·∫£nh ch·ªØ k√Ω
            let signatureImage;
            if (imgInput.name.toLowerCase().endsWith('.png')) {
                signatureImage = await pdfDoc.embedPng(imgBytes);
            } else {
                signatureImage = await pdfDoc.embedJpg(imgBytes);
            }

            // 3. D√πng PDF.JS ƒë·ªÉ QU√âT V·ªä TR√ç CH·ªÆ (ƒê√¢y l√† ph·∫ßn kh√≥ nh·∫•t ·ªü JS)
            const loadingTask = pdfjsLib.getDocument({data: pdfBytes});
            const pdfScanner = await loadingTask.promise;
            
            let count = 0;
            const totalPages = pdfScanner.numPages;

            log(`T·ªïng s·ªë trang: ${totalPages}. ƒêang qu√©t t√¨m t√™n "${nameToFind}"...`);

            for (let i = 1; i <= totalPages; i++) {
                const page = await pdfScanner.getPage(i);
                const textContent = await page.getTextContent();
                const viewport = page.getViewport({scale: 1}); // L·∫•y k√≠ch th∆∞·ªõc chu·∫©n

                // Duy·ªát qua t·ª´ng d√≤ng ch·ªØ trong trang
                for (let item of textContent.items) {
                    // Ki·ªÉm tra xem d√≤ng ch·ªØ c√≥ ch·ª©a T√™n kh√¥ng
                    if (item.str.includes(nameToFind)) {
                        log(`--> T√¨m th·∫•y t·∫°i trang ${i}`);
                        
                        // L·∫•y to·∫° ƒë·ªô t·ª´ PDF.JS
                        // item.transform l√† m·∫£ng [scaleX, skewY, skewX, scaleY, x, y]
                        const x_text = item.transform[4]; 
                        const y_text = item.transform[5];
                        const textWidth = item.width; // Chi·ªÅu r·ªông c·ªßa d√≤ng ch·ªØ
                        
                        // T√≠nh to√°n v·ªã tr√≠ ch√®n (t∆∞∆°ng t·ª± logic Python c≈©)
                        const x_img = x_text + (textWidth - width) / 2;
                        const y_img = y_text + offset; // PDF-Lib v√† PDF.JS ƒë·ªÅu d√πng h·ªá to·∫° ƒë·ªô t·ª´ d∆∞·ªõi l√™n (Bottom-Left)

                        // Ch√®n v√†o trang b·∫±ng PDF-LIB
                        const pdfPage = pdfDoc.getPages()[i - 1]; // Trang trong pdf-lib b·∫Øt ƒë·∫ßu t·ª´ 0
                        
                        // ƒêi·ªÅu ch·ªânh y m·ªôt ch√∫t v√¨ font ch·ªØ c√≥ ƒë·ªô cao
                        const adjustedY = y_img + 5; 

                        pdfPage.drawImage(signatureImage, {
                            x: x_img,
                            y: adjustedY,
                            width: width,
                            height: height,
                        });
                        count++;
                    }
                }
            }

            if (count > 0) {
                // 4. L∆∞u v√† t·∫£i v·ªÅ
                log("ƒêang t·∫°o file m·ªõi...");
                const pdfBytesSaved = await pdfDoc.save();
                const blob = new Blob([pdfBytesSaved], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = pdfInput.name.replace(".pdf", "_signed.pdf");
                link.click();
                log(`‚úÖ TH√ÄNH C√îNG! ƒê√£ k√Ω ${count} ch·ªó.`);
                alert(`ƒê√£ k√Ω xong ${count} v·ªã tr√≠! File ƒëang ƒë∆∞·ª£c t·∫£i xu·ªëng.`);
            } else {
                log("‚ö†Ô∏è KH√îNG T√åM TH·∫§Y T√äN.");
                alert("Kh√¥ng t√¨m th·∫•y t√™n trong file. L∆∞u √Ω: Phi√™n b·∫£n Web t√¨m ki·∫øm ch√≠nh x√°c t·ª´ng k√Ω t·ª±, n·∫øu t√™n b·ªã ng·∫Øt d√≤ng c√≥ th·ªÉ kh√¥ng th·∫•y.");
            }

        } catch (error) {
            console.error(error);
            log(`‚ùå L·ªñI: ${error.message}`);
            alert("C√≥ l·ªói x·∫£y ra. Xem chi ti·∫øt trong khung ƒëen.");
        }
    }
</script>

</body>
</html>

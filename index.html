<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S·ªï tay CNQL - B·∫£n ƒë·ªì</title>
    
    <link rel="stylesheet" href="style.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <style>
        /* T√πy ch·ªânh ri√™ng cho trang B·∫£n ƒë·ªì */
        body, html { height: 100%; overflow: hidden; }
        
        /* B·∫£n ƒë·ªì chi·∫øm to√†n b·ªô ph·∫ßn c√≤n l·∫°i sau Header */
        #map {
            width: 100%;
            height: calc(100vh - 60px); /* Tr·ª´ ƒëi chi·ªÅu cao Header */
            z-index: 1;
        }

        /* N√∫t Check-in (Floating Action Button) */
        .fab-checkin {
            position: absolute;
            bottom: 30px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #007aff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000; /* N·ªïi tr√™n b·∫£n ƒë·ªì */
            transition: transform 0.2s;
        }
        .fab-checkin:active { transform: scale(0.95); background-color: #0056b3; }

        /* Popup th√¥ng tin tr·ª• */
        .pylon-popup b { color: #d32f2f; }
        .btn-report {
            background-color: #d32f2f;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            width: 100%;
        }
    </style>
</head>
<body>

    <header class="app-header">
        <span class="menu-btn">‚ò∞</span>
        <span class="page-title">B·∫£n ƒë·ªì l∆∞·ªõi ƒëi·ªán</span>
    </header>

    <div id="map"></div>

    <div class="fab-checkin" onclick="performCheckIn()" title="Check-in v·ªã tr√≠">
        üìç
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script src="firebase-config.js"></script>

    <script src="ui-core.js"></script>

    <script>
        // --- D·ªÆ LI·ªÜU M·∫™U (M√¥ ph·ªèng DB Firestore) ---
        [span_1](start_span)// D·ª±a tr√™n Nh√≥m 1: Tuy·∫øn Nh√† B√® - An Nghƒ©a[span_1](end_span)
        const pylons = [
            { id: "NB-AN-01", code: "T01", lat: 10.6975, lng: 106.7565, status: "normal", line: "110kV Nh√† B√® - An Nghƒ©a" },
            { id: "NB-AN-02", code: "T02", lat: 10.6950, lng: 106.7580, status: "warning", line: "110kV Nh√† B√® - An Nghƒ©a" }, // Tr·ª• c√≥ c·∫£nh b√°o
            { id: "NB-AN-03", code: "T03", lat: 10.6925, lng: 106.7595, status: "normal", line: "110kV Nh√† B√® - An Nghƒ©a" }
        ];

        let map, userMarker;

        // Kh·ªüi t·∫°o b·∫£n ƒë·ªì khi trang t·∫£i xong
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });

        function initMap() {
            // T·ªça ƒë·ªô trung t√¢m (Khu v·ª±c Nh√† B√® TP.HCM)
            map = L.map('map').setView([10.6950, 106.7580], 15);

            // Th√™m l·ªõp b·∫£n ƒë·ªì n·ªÅn (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Hi·ªÉn th·ªã c√°c tr·ª• ƒëi·ªán l√™n b·∫£n ƒë·ªì
            renderPylons();

            // ƒê·ªãnh v·ªã ng∆∞·ªùi d√πng ban ƒë·∫ßu
            locateUser();
        }

        function renderPylons() {
            const pylonIconNormal = L.divIcon({
                className: 'custom-icon',
                html: '<div style="background-color:green; width:15px; height:15px; border-radius:50%; border:2px solid white;"></div>',
                iconSize: [20, 20]
            });

            const pylonIconWarning = L.divIcon({
                className: 'custom-icon',
                html: '<div style="background-color:red; width:15px; height:15px; border-radius:50%; border:2px solid white; animation: blink 1s infinite;"></div>',
                iconSize: [20, 20]
            });

            pylons.forEach(pylon => {
                const icon = pylon.status === 'warning' ? pylonIconWarning : pylonIconNormal;
                
                const marker = L.marker([pylon.lat, pylon.lng], {icon: icon}).addTo(map);
                
                // N·ªôi dung Popup khi b·∫•m v√†o tr·ª•
                const popupContent = `
                    <div class="pylon-popup">
                        <h3>Tr·ª• ${pylon.code}</h3>
                        <p><b>Tuy·∫øn:</b> ${pylon.line}</p>
                        <p><b>Tr·∫°ng th√°i:</b> ${pylon.status === 'normal' ? 'B√¨nh th∆∞·ªùng' : 'C·∫ßn ki·ªÉm tra'}</p>
                        <button class="btn-report" onclick="window.location.href='report.html?pylon=${pylon.code}'">‚ö†Ô∏è B√°o c√°o s·ª± c·ªë</button>
                    </div>
                `;
                marker.bindPopup(popupContent);
            });
        }

        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    
                    // Icon ng∆∞·ªùi d√πng
                    const userIcon = L.divIcon({
                        className: 'user-pos',
                        html: '<div style="width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid blue;"></div>',
                        iconSize: [20, 20]
                    });

                    if (userMarker) map.removeLayer(userMarker);
                    userMarker = L.marker([latitude, longitude], {icon: userIcon}).addTo(map);
                    
                    // Zoom ƒë·∫øn v·ªã tr√≠ ng∆∞·ªùi d√πng (ch·ªâ l·∫ßn ƒë·∫ßu)
                    // map.setView([latitude, longitude], 16);
                });
            }
        }

        // Ch·ª©c nƒÉng Check-in (Logic gi·∫£ l·∫≠p)
        window.performCheckIn = function() {
            if (!navigator.geolocation) {
                alert("Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ GPS!");
                return;
            }

            // Hi·ªáu ·ª©ng loading
            const btn = document.querySelector('.fab-checkin');
            btn.innerHTML = '‚è≥';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    
                    // Gi·∫£ s·ª≠ kho·∫£ng c√°ch ch·∫•p nh·∫≠n ƒë∆∞·ª£c l√† 0.0005 ƒë·ªô (~50m)
                    // Logic th·ª±c t·∫ø s·∫Ω d√πng c√¥ng th·ª©c Haversine ƒë·ªÉ t√≠nh kho·∫£ng c√°ch t·ªõi tr·ª• g·∫ßn nh·∫•t
                    
                    // Demo: Lu√¥n b√°o th√†nh c√¥ng v√† hi·ªÉn th·ªã t·ªça ƒë·ªô
                    setTimeout(() => {
                        alert(`‚úÖ CHECK-IN TH√ÄNH C√îNG!\n\nT·ªça ƒë·ªô: ${userLat.toFixed(5)}, ${userLng.toFixed(5)}\nTh·ªùi gian: ${new Date().toLocaleString()}\n\nD·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c g·ª≠i v·ªÅ m√°y ch·ªß.`);
                        btn.innerHTML = 'üìç'; // Reset icon
                    }, 1000);
                },
                (error) => {
                    alert("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. Vui l√≤ng b·∫≠t GPS.");
                    btn.innerHTML = 'üìç';
                }
            );
        };
    </script>
</body>
</html>
